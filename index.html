<!DOCTYPE html>
<html>
<head>
    <title>City Clock</title>
    <style>
        body { margin: 0; background: #050505; color: white; font-family: 'Inter', sans-serif; 
               display: flex; justify-content: center; align-items: center; height: 100vh; }
        #container { text-align: center; transition: opacity 1s; opacity: 1; }
        .city { font-size: clamp(3rem, 10vw, 8rem); font-weight: 900; letter-spacing: -2px; line-height: 1; }
        .country { font-size: 1.5rem; color: #666; margin-top: 1rem; text-transform: uppercase; letter-spacing: 4px; }
        .clock { font-size: 1.2rem; margin-top: 2rem; font-family: monospace; color: #444; }
        .fade-out { opacity: 0; }
    </style>
</head>
<body>
    <div id="container">
        <div class="city" id="city">--</div>
        <div class="country" id="country">--</div>
        <div class="clock" id="clock">00:00:00</div>
    </div>

    <script>
        let cities = [];
        let index = 0;
        const targetHour = new URLSearchParams(window.location.search).get('target_hour') || 17;

        async function fetchData() {
            const res = await fetch(`/api/cities?target_hour=${targetHour}`);
            cities = await res.json();
            if (cities.length > 0 && index === 0) updateDisplay();
        }

        function updateDisplay() {
            if (cities.length === 0) return;
            const container = document.getElementById('container');
            container.classList.add('fade-out');

            setTimeout(() => {
                const city = cities[index % cities.length];
                document.getElementById('city').innerText = city.name;
                document.getElementById('country').innerText = city.country;
                index++;
                container.classList.remove('fade-out');
            }, 1000);
        }

        function updateClocks() {
            if (cities.length === 0) return;
            // Real-time local clock calculation
            const city = cities[(index - 1) % cities.length];
            const now = new Date();
            const localStr = now.toLocaleTimeString('en-GB', { timeZone: city.timezone });
            document.getElementById('clock').innerText = `${localStr} ${city.tz_abbr}`;
        }

        fetchData();
        setInterval(fetchData, 60000); // Refresh data every minute
        setInterval(updateDisplay, 10000); // Rotate city every 10s
        setInterval(updateClocks, 1000); // Update clock every second
    </script>
</body>
</html>